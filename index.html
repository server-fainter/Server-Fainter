<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>fainter í´ë¼ì´ì–¸íŠ¸</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .container {
            text-align: center;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2rem;
            color: #333;
            margin-bottom: 20px;
        }

        canvas {
            border: 2px solid #000;
            border-radius: 5px;
            margin-bottom: 15px;
            width: 500px;
            height: 500px;
            image-rendering: pixelated;
        }

        #color-picker {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        #color-picker label {
            font-size: 1.2rem;
            color: #555;
        }

        #color-picker input[type="color"] {
            width: 40px;
            height: 40px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            padding: 0;
        }

        #recent-colors {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .color-box {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            border: 2px solid #ccc;
        }

        .hovered {
            box-shadow: 0 0 10px 5px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>FAINTER CANVAS</h1>
        <canvas id="canvas" width="100" height="100"></canvas>
        <div id="color-picker">
            <label for="color">ğŸ¨ ìƒ‰ìƒ ì„ íƒ:</label>
            <input type="color" id="color" value="#ff0000">
        </div>
        <div id="recent-colors">
            <!-- ìµœê·¼ ìƒ‰ìƒë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const colorInput = document.getElementById('color');
        const recentColorsContainer = document.getElementById('recent-colors');
        
        // ìµœê·¼ ìƒ‰ìƒ ìŠ¤íƒ (ìµœëŒ€ 5ê°œ)
        let recentColors = [];

        // ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ í™•ëŒ€í•˜ì—¬ í‘œì‹œ (í”½ì…€ í™•ëŒ€ íš¨ê³¼)
        canvas.style.width = '500px';  // í™”ë©´ì— ë³´ì—¬ì§€ëŠ” í¬ê¸°
        canvas.style.height = '500px'; // í™”ë©´ì— ë³´ì—¬ì§€ëŠ” í¬ê¸°
        canvas.width = 100;            // ì‹¤ì œ ìº”ë²„ìŠ¤ í¬ê¸°
        canvas.height = 100;           // ì‹¤ì œ ìº”ë²„ìŠ¤ í¬ê¸°

        // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
        let pixelData = new Uint8Array(100 * 100 * 4); // RGBA í˜•ì‹

        // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”: ëª¨ë“  í”½ì…€ì„ í°ìƒ‰ìœ¼ë¡œ ì„¤ì •
        for (let i = 0; i < pixelData.length; i += 4) {
            pixelData[i] = 255;     // R
            pixelData[i + 1] = 255; // G
            pixelData[i + 2] = 255; // B
            pixelData[i + 3] = 255; // A (ë¶ˆíˆ¬ëª…ë„)
        }
        updateCanvas();

        // ì„œë²„ì— ì—°ê²°
        const ws = new WebSocket('ws://localhost:8080');
        ws.binaryType = 'arraybuffer';

        ws.onopen = function () {
            console.log('WebSocket ì—°ê²° ì„±ê³µ');
        };

        ws.onmessage = function (event) {
            const data = new Uint8Array(event.data);
            let i = 0;
            while (i + 2 < data.length) {
                const x = data[i];
                const y = data[i + 1];
                const color = data[i + 2];
                i += 3;

                // ìƒ‰ìƒì„ ì ìš©í•˜ì—¬ í”½ì…€ ë°ì´í„° ì—…ë°ì´íŠ¸
                const index = (y * 100 + x) * 4;
                const rgbColor = colorToRGB(color);
                pixelData[index] = rgbColor.r;
                pixelData[index + 1] = rgbColor.g;
                pixelData[index + 2] = rgbColor.b;
                pixelData[index + 3] = 255; // ë¶ˆíˆ¬ëª…ë„
            }
            updateCanvas();
        };

        ws.onclose = function () {
            console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
        };

        ws.onerror = function (error) {
            console.error('WebSocket ì˜¤ë¥˜:', error);
        };

        // í˜¸ë²„í•œ í”½ì…€ì— ê·¸ë¦¼ì íš¨ê³¼ ì ìš©
        let hoveredPixel = { x: -1, y: -1 };
        
        canvas.addEventListener('mousemove', function (event) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = Math.floor((event.clientX - rect.left) * scaleX);
            const y = Math.floor((event.clientY - rect.top) * scaleY);
            
            if (hoveredPixel.x !== x || hoveredPixel.y !== y) {
                hoveredPixel = { x, y };
                updateCanvas();  // í˜¸ë²„ ì‹œ ìº”ë²„ìŠ¤ ë‹¤ì‹œ ì—…ë°ì´íŠ¸
            }
        });

        canvas.addEventListener('click', function (event) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;  // ìº”ë²„ìŠ¤ì˜ ì‹¤ì œ í¬ê¸° ëŒ€ë¹„ ìŠ¤íƒ€ì¼ í¬ê¸° ë¹„ìœ¨
            const scaleY = canvas.height / rect.height;
            const x = Math.floor((event.clientX - rect.left) * scaleX);
            const y = Math.floor((event.clientY - rect.top) * scaleY);

            // ìƒ‰ìƒ ë³€í™˜
            const colorHex = colorInput.value;
            const rgbColor = hexToRGB(colorHex);

            // ì„œë²„ë¡œ í”½ì…€ ì •ë³´ ì „ì†¡
            const message = new Uint8Array([x, y, rgbColor.r, rgbColor.g, rgbColor.b]);
            ws.send(message.buffer);

            // ìµœê·¼ ìƒ‰ìƒ ìŠ¤íƒ ì—…ë°ì´íŠ¸
            updateRecentColors(colorHex);
            console.log(message.buffer)
        });

        // í—¥ì‚¬ ìƒ‰ìƒì„ RGBë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function hexToRGB(hex) {
            const r = parseInt(hex.substr(1, 2), 16);
            const g = parseInt(hex.substr(3, 2), 16);
            const b = parseInt(hex.substr(5, 2), 16);
            return { r, g, b };
        }

        // ìº”ë²„ìŠ¤ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateCanvas() {
            const imageData = new ImageData(new Uint8ClampedArray(pixelData), 100, 100);
            ctx.putImageData(imageData, 0, 0);

            // í˜¸ë²„ëœ í”½ì…€ì— ê·¸ë¦¼ì íš¨ê³¼ ì¶”ê°€
            if (hoveredPixel.x >= 0 && hoveredPixel.y >= 0) {
                const index = (hoveredPixel.y * 100 + hoveredPixel.x) * 4;
                ctx.save();
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                ctx.shadowBlur = 5;
                ctx.shadowColor = "rgba(0, 0, 0, 0.7)";  // ê·¸ë¦¼ì ìƒ‰ìƒ ì„¤ì •
                ctx.fillStyle = `rgb(${pixelData[index]}, ${pixelData[index + 1]}, ${pixelData[index + 2]})`;
                ctx.fillRect(hoveredPixel.x * 5, hoveredPixel.y * 5, 5, 5);  // í™•ëŒ€ëœ í¬ê¸°ë¡œ ê·¸ë¦¼ì íš¨ê³¼
                ctx.restore();
            }
        }

        // ìµœê·¼ ìƒ‰ìƒ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateRecentColors(color) {
            if (recentColors.length >= 5) {
                recentColors.shift();  // ìŠ¤íƒì˜ í¬ê¸°ê°€ 5ê°œë¥¼ ì´ˆê³¼í•˜ë©´ ê°€ì¥ ì˜¤ë˜ëœ ìƒ‰ìƒì„ ì œê±°
            }
            recentColors.push(color);  // ìƒˆë¡œìš´ ìƒ‰ìƒ ì¶”ê°€

            // ìµœê·¼ ìƒ‰ìƒ í‘œì‹œ ì—…ë°ì´íŠ¸
            recentColorsContainer.innerHTML = '';
            recentColors.forEach(c => {
                const colorBox = document.createElement('div');
                colorBox.classList.add('color-box');
                colorBox.style.backgroundColor = c;
                recentColorsContainer.appendChild(colorBox);
            });
        }
    </script>
</body>
</html>
