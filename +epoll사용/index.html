<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>r/place 클라이언트</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f7f7f7;
        color: #333;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        flex-direction: column;
        overflow: scroll;
      }
      #client-count-box {
        position: fixed;
        top: 2vh;
        right: 2vw;
        padding: 1vh 2vw;
        background-color: #fff;
        color: #333;
        border: 0.2vw solid #ccc;
        border-radius: 1vw;
        box-shadow: 0 0.4vh 0.8vh rgba(0, 0, 0, 0.1);
        font-size: 2vw;
        font-weight: bold;
        z-index: 1000;
      }
      .hor {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1vh;
        border-radius: 1vw;
      }
      .palette {
        display: grid;
        grid-template-columns: repeat(
          15,
          2vw
        ); /* 컬러 박스 너비를 vw 단위로 변경 */
        gap: 1vw; /* 간격도 vw 단위로 변경 */
        margin-top: 1vh;
      }

      .color-box {
        width: 2vw; /* 너비를 vw 단위로 변경 */
        height: 2vw; /* 높이를 vw 단위로 변경 */
        border: 0.1vw solid #ccc;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .color-box.active {
        border: 0.15vw solid #444; /* 활성화된 컬러 박스의 테두리 */
        box-shadow: 0 0.4vh rgba(0, 0, 0, 0.2);
      }

      #color-palette-bar {
        bottom: 1vh;
        right: 1vh;
        position: fixed;
        z-index: 1000;

        padding: 1vh;
        background-color: #ccc;
      }

      .color-box:hover {
        transform: scale(1.2);
      }
      canvas {
        background-color: #fff;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 2px solid #444;
        image-rendering: pixelated;
        cursor: crosshair;
      }

      footer {
        margin-top: 100px;
      }
    </style>
  </head>
  <body>
    <div id="client-count-box">
      <span>동접자 수: </span>
      <span id="client-count">0</span>
    </div>
    <div class="hor">
      <canvas id="canvas" width="100" height="100"></canvas>
    </div>
    <div id="color-palette-bar">
      <div class="palette" id="color-palette"></div>
    </div>
    <footer>
      <div style="display: flex; justify-content: center">
        <div style="margin: 5%">
          <a href="https://github.com/server-fainter" target="_blank">
            <img
              src="image.png"
              alt="팀 서버페인터"
              style="width: 100px; height: auto; border-radius: 10%"
            />
          </a>
        </div>
        <div>
          <p>프로젝트 fainter</p>
          <p>팀원: 홍길동, 김철수, 이영희</p>
          <p>개발일: 2024년 11월</p>
        </div>
      </div>
    </footer>
    <!-- <h1>r/place 클라이언트</h1>
    <canvas id="canvas" width="100" height="100"></canvas>
    <div id="color-picker">
      <label for="color">색상 선택:</label>
      <select id="color">
        <option value="0">흰색</option>
        <option value="1">검은색</option>
        <option value="2" selected>빨강</option>
        <option value="3">초록</option>
        <option value="4">파랑</option>
        <option value="5">노랑</option>
        <option value="6">청록</option>
        <option value="7">자홍</option>
      </select>
      <span id="color-preview"></span>
    </div> -->

    <script>
      //캔버스 및 화면 요소
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const colorInput = document.getElementById("color");
      const colorPalette = document.getElementById("color-palette");

      // 캔버스 크기를 확대하여 표시 (픽셀 확대 효과)
      canvas.style.width = "600px";
      canvas.style.height = "600px";
      //---------------------------------------------------
      //색상인덱스
      const colorsHex = [
        "#ff0000",
        "#ffa600",
        "#ffe600",
        "#8aff00",
        "#24ff00",
        "#00ff00",
        "#00ff83",
        "#00ffe6",
        "#00e7ff",
        "#008fff",
        "#0024ff",
        "#2400ff",
        "#8a00ff",
        "#ff00ff",
        "#ff0083",
        "#ff0024",
        "#d70000",
        "#8c4000",
        "#e67c00",
        "#b1d700",
        "#4cc100",
        "#00c16a",
        "#00c1c1",
        "#0055c1",
        "#002fc1",
        "#7200c1",
        //"#c100c1",
        "#c10072", //자주
        "#8c2600", //갈색
        "#000000", //검정
        "#ffffff", //하양
      ];
      //colorHex를 통해 팔레트 리스트 생성
      colorsHex.forEach((color, Index) => {
        //colorBox객체에 div를 여러개 두어 color-box생성
        const colorBox = document.createElement("div");
        colorBox.className = "color-box";
        //각 원소 색으로 박스 채우기
        colorBox.style.backgroundColor = color;
        //컬러박스에 이벤트리스너
        colorBox.addEventListener("click", () => {
          // 클릭된애는 선택된 컬러로 처리
          selectColor(color, Index);

          // 이전 활성화된 컬러 박스에서 active 클래스 제거
          document
            .querySelectorAll(".color-box.active")
            .forEach((activeBox) => {
              activeBox.classList.remove("active");
            });

          // 현재 클릭된 컬러 박스에 active 클래스 추가
          colorBox.classList.add("active");
        });
        colorPalette.appendChild(colorBox);
      });

      // 선택된 색상: 색 이름과 인덱스(colorHex) 값
      let selectedColor = "#000000";
      let selectedColor_Index = 29;

      //클릭된 애->선택: 컬러전역변수 설정
      function selectColor(color, Index) {
        selectedColor = color;
        selectedColor_Index = Index;
        console.log(`선택된 색상: ${selectedColor_Index}:${color}`);
      }

      // 색상 인덱스를 RGB로 변환하는 함수
      // 캔버스 업데이트 시 필요
      //ex 2->r,g,b
      function colorToRGB(colorIndex) {
        const colors = [
          { r: 255, g: 0, b: 0 }, // #ff0000 (빨강)
          { r: 255, g: 166, b: 0 }, // #ffa600 (주황)
          { r: 255, g: 230, b: 0 }, // #ffe600 (노랑)
          { r: 138, g: 255, b: 0 }, // #8aff00 (연두)
          { r: 36, g: 255, b: 0 }, // #24ff00 (연두)
          { r: 0, g: 255, b: 0 }, // #00ff00 (초록)
          { r: 0, g: 255, b: 131 }, // #00ff83 (청록)
          { r: 0, g: 255, b: 230 }, // #00ffe6 (청록)
          { r: 0, g: 231, b: 255 }, // #00e7ff (하늘)
          { r: 0, g: 143, b: 255 }, // #008fff (파랑)
          { r: 0, g: 36, b: 255 }, // #0024ff (파랑)
          { r: 36, g: 0, b: 255 }, // #2400ff (파랑)
          { r: 138, g: 0, b: 255 }, // #8a00ff (자주)
          { r: 255, g: 0, b: 255 }, // #ff00ff (자홍)
          { r: 255, g: 0, b: 131 }, // #ff0083 (분홍)
          { r: 255, g: 0, b: 36 }, // #ff0024 (빨강)
          { r: 215, g: 0, b: 0 }, // #d70000 (적색)
          { r: 140, g: 64, b: 0 }, // #8c4000 (갈색)
          { r: 230, g: 124, b: 0 }, // #e67c00 (주황)
          { r: 177, g: 215, b: 0 }, // #b1d700 (연두)
          { r: 76, g: 193, b: 0 }, // #4cc100 (연두)
          { r: 0, g: 193, b: 106 }, // #00c16a (청록)
          { r: 0, g: 193, b: 193 }, // #00c1c1 (청록)
          { r: 0, g: 85, b: 193 }, // #0055c1 (파랑)
          { r: 0, g: 47, b: 193 }, // #002fc1 (파랑)
          { r: 114, g: 0, b: 193 }, // #7200c1 (보라)
          // { r: 193, g: 0, b: 193 }, // #c100c1 (보라)
          { r: 193, g: 0, b: 114 }, // #c10072 (보라)
          { r: 140, g: 38, b: 0 }, // #8c2600 (갈색)
          { r: 0, g: 0, b: 0 }, // 검정
          { r: 255, g: 255, b: 255 }, // 하양
        ];

        return colors[colorIndex % colors.length];
      }
      //---------------------------------------------------
      // 캔버스 초기화
      let pixelData = new Uint8Array(100 * 100 * 4); // RGBA 형식

      // 캔버스 초기화: 모든 픽셀을 흰색으로 설정
      for (let i = 0; i < pixelData.length; i += 4) {
        pixelData[i] = 255; // R
        pixelData[i + 1] = 255; // G
        pixelData[i + 2] = 255; // B
        pixelData[i + 3] = 255; // A (불투명도)
      }
      updateCanvas();
      //---------------------------------------------------
      // 서버에 연결
      const ws = new WebSocket("ws://localhost:8080"); // C 서버의 포트로 연결
      ws.binaryType = "arraybuffer";
      // 웹 소켓 오픈
      ws.onopen = function () {
        console.log("WebSocket 연결 성공");
      };
      //서버로부터 온 메세지
      ws.onmessage = function (event) {
        const data = new Uint8Array(event.data);
        let i = 0;
        while (i + 2 < data.length) {
          const x = data[i];
          const y = data[i + 1];
          const color = data[i + 2];
          i += 3;

          // 색상을 적용하여 픽셀 데이터 업데이트
          // color: color배열을 기반으로하는 인덱스가 넘어옴
          // 업데이트에는 rgba가 필요
          // 즉 hex color->> colorToRGB-->> r,g,b,a
          const index = (y * 100 + x) * 4;
          const rgbColor = colorToRGB(color);
          pixelData[index] = rgbColor.r;
          pixelData[index + 1] = rgbColor.g;
          pixelData[index + 2] = rgbColor.b;
          pixelData[index + 3] = 255; // 불투명도 (변경하지 않음)
        }
        //캔버스 업데이트
        updateCanvas();
      };

      ws.onclose = function () {
        console.log("WebSocket 연결 종료");
      };

      ws.onerror = function (error) {
        console.error("WebSocket 오류:", error);
      };
      //---------------------------------------------------

      // 캔버스에 클릭 이벤트 리스너 추가
      canvas.addEventListener("click", function (event) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const x = Math.floor((event.clientX - rect.left) * scaleX);
        const y = Math.floor((event.clientY - rect.top) * scaleY);

        const color = selectedColor_Index;

        // 서버로 픽셀 정보 전송 (3바이트)
        const message = new Uint8Array([x, y, color]);

        if (ws.readyState === WebSocket.OPEN) {
          ws.send(message.buffer);
          console.log(`Sent pixel update: (${x}, ${y}) with color ${color}`);
        } else {
          console.warn(
            "WebSocket이 열려 있지 않습니다. 메시지를 보낼 수 없습니다."
          );
        }
      });

      // 캔버스 업데이트 함수
      function updateCanvas() {
        const imageData = new ImageData(
          new Uint8ClampedArray(pixelData),
          100,
          100
        );
        ctx.putImageData(imageData, 0, 0);
      }
    </script>
  </body>
</html>
